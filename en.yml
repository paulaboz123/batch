- task: AzureCLI@2
  name: deploy_managed_endpoint
  displayName: Deploy Managed Endpoint
  inputs:
    azureSubscription: ${{parameters.serviceConnection}}
    scriptType: bash
    scriptLocation: inlineScript
    failOnStandardError: false
    inlineScript: |
      set -e

      az configure --defaults workspace=${{parameters.amlWorkspace}} group=${{parameters.resourceGroup}}

      ENDPOINT_FILE="endpoint-${{ lower(parameters.bu) }}.yml"
      ENDPOINT_NAME=$(yq '.name' "$ENDPOINT_FILE")
      KEY_VAULT_NAME=${{ parameters.keyVaultName }}

      EXISTING_COUNT=$(az ml batch-endpoint list --query "[?name=='$ENDPOINT_NAME'] | length(@)" -o tsv)

      if [ "$EXISTING_COUNT" == "0" ]; then
        echo "Create batch endpoint..."
        az ml batch-endpoint create -f "$ENDPOINT_FILE"
      else
        echo "Update batch endpoint..."
        az ml batch-endpoint update -f "$ENDPOINT_FILE"
      fi

      # Jeśli dalej potrzebujesz klucza endpointu w KV (tak jak wcześniej)
      ENDPOINT_KEY=$(az ml batch-endpoint get-credentials -n "$ENDPOINT_NAME" -o tsv --query primaryKey)
      az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "UnifiedModelApiKey" --value "$ENDPOINT_KEY"
  workingDirectory: src/deployment/managed_endpoint/${{parameters.environment}}/

















- task: AzureCLI@2
  name: deploy_model_managed_endpoint
  displayName: Deploy Model To Managed Endpoint
  inputs:
    azureSubscription: ${{parameters.serviceConnection}}
    scriptType: bash
    scriptLocation: inlineScript
    failOnStandardError: false
    inlineScript: |
      set -e

      az configure --defaults workspace=${{parameters.amlWorkspace}} group=${{parameters.resourceGroup}}

      MODEL_FILE="model-${{ lower(parameters.bu) }}.yml"
      ENDPOINT_NAME=$(yq '.endpoint_name' "$MODEL_FILE")
      DEPLOYMENT_NAME=$(yq '.name' "$MODEL_FILE")

      EXISTING_COUNT=$(az ml batch-deployment list -e "$ENDPOINT_NAME" --query "[?name=='$DEPLOYMENT_NAME'] | length(@)" -o tsv)

      if [ "$EXISTING_COUNT" == "0" ]; then
        echo "Create batch deployment for $DEPLOYMENT_NAME..."
        az ml batch-deployment create -f "$MODEL_FILE"
      else
        echo "Update batch deployment for $DEPLOYMENT_NAME..."
        az ml batch-deployment update -f "$MODEL_FILE"
      fi

      # Ustaw domyślny deployment (batch nie ma traffic split jak online)
      az ml batch-endpoint update -n "$ENDPOINT_NAME" --set defaults.deployment_name="$DEPLOYMENT_NAME"
  workingDirectory: src/deployment/managed_endpoint/${{parameters.environment}}/












